CREATE PROCEDURE [dbo].[uspSCTicketClearLoadDetail]
	@TICKET_ID INT
	,@USER_ID INT
	,@DELETE_ALL BIT = 0
AS
	
	DECLARE @DISTRIBUTION_OPTION NVARCHAR(50)
	DECLARE @LOAD_ID INT 
	DECLARE @CONTINUE_DELETE BIT = 1

	SELECT
		
		@DISTRIBUTION_OPTION = strDistributionOption
		,@LOAD_ID = intLoadId

	FROM tblSCTicket
	WHERE intTicketId = @TICKET_ID



	IF @DISTRIBUTION_OPTION = 'LRF'
	BEGIN


		-- WE NEED TO CHECK IF THE DUMMY IS ALREADY DELETED 
		-- THE AFFECTED PROCESS IS DURING A SPLIT MANUAL DISTRIBUTION WHERE THE DISTRIBUTION IS CALLED nTimes DENDING ON THE SPLIT

		IF @DELETE_ALL = 0
		BEGIN			
			IF EXISTS( SELECT TOP 1 1 FROM tblLGLoadDetail WHERE intLoadId = @LOAD_ID AND intVendorEntityId IS NOT NULL )
			BEGIN
				SET @CONTINUE_DELETE = 0		
			END
		END


		IF @CONTINUE_DELETE =1 
		BEGIN
			DECLARE @TEMP_LOAD_DETAIL_ID TABLE( ID INT)
			DECLARE @CURRENT_LOAD_DETAIL_ID INT

			INSERT INTO @TEMP_LOAD_DETAIL_ID (ID)
			SELECT intLoadDetailId
			FROM tblLGLoadDetail
			WHERE intLoadId = @LOAD_ID

			SELECT @CURRENT_LOAD_DETAIL_ID = MIN(ID) FROM @TEMP_LOAD_DETAIL_ID

			WHILE @CURRENT_LOAD_DETAIL_ID IS NOT NULL
			BEGIN
				
				EXEC uspLGDeleteLoadDetail @intLoadDetailId = @CURRENT_LOAD_DETAIL_ID, @intEntityUserId = @USER_ID


				DELETE FROM @TEMP_LOAD_DETAIL_ID WHERE ID = @CURRENT_LOAD_DETAIL_ID
				SELECT @CURRENT_LOAD_DETAIL_ID = MIN(ID) FROM @TEMP_LOAD_DETAIL_ID
			END
		END
		



	END

GO



