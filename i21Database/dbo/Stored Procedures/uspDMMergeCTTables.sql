CREATE PROCEDURE [dbo].[uspDMMergeCTTables]
    @remoteDB NVARCHAR(MAX)
AS

SET QUOTED_IDENTIFIER OFF
SET ANSI_NULLS ON
SET NOCOUNT ON
SET XACT_ABORT ON

DECLARE @SQLString NVARCHAR(MAX) = '';

BEGIN

    -- tblCTContractHeader
    SET @SQLString = N'MERGE tblCTContractHeader AS Target
        USING (SELECT * FROM REMOTEDBSERVER.[repDB].[dbo].[tblCTContractHeader]) AS Source
        ON (Target.intContractHeaderId = Source.intContractHeaderId)
        WHEN MATCHED THEN
            UPDATE SET Target.intConcurrencyId = Source.intConcurrencyId, Target.intContractTypeId = Source.intContractTypeId, Target.intEntityId = Source.intEntityId, Target.intEntityContactId = Source.intEntityContactId, Target.intContractPlanId = Source.intContractPlanId, Target.intCommodityId = Source.intCommodityId, Target.dblQuantity = Source.dblQuantity, Target.intCommodityUOMId = Source.intCommodityUOMId, Target.strContractNumber = Source.strContractNumber, Target.dtmContractDate = Source.dtmContractDate, Target.strCustomerContract = Source.strCustomerContract, Target.dtmDeferPayDate = Source.dtmDeferPayDate, Target.dblDeferPayRate = Source.dblDeferPayRate, Target.intContractTextId = Source.intContractTextId, Target.ysnSigned = Source.ysnSigned, Target.dtmSigned = Source.dtmSigned, Target.ysnPrinted = Source.ysnPrinted, Target.intSalespersonId = Source.intSalespersonId, Target.intGradeId = Source.intGradeId, Target.intWeightId = Source.intWeightId, Target.intCropYearId = Source.intCropYearId, Target.strInternalComment = Source.strInternalComment, Target.strPrintableRemarks = Source.strPrintableRemarks, Target.intAssociationId = Source.intAssociationId, Target.intTermId = Source.intTermId, Target.intPricingTypeId = Source.intPricingTypeId, Target.intApprovalBasisId = Source.intApprovalBasisId, Target.intContractBasisId = Source.intContractBasisId, Target.intPositionId = Source.intPositionId, Target.intInsuranceById = Source.intInsuranceById, Target.intInvoiceTypeId = Source.intInvoiceTypeId, Target.dblTolerancePct = Source.dblTolerancePct, Target.dblProvisionalInvoicePct = Source.dblProvisionalInvoicePct, Target.ysnSubstituteItem = Source.ysnSubstituteItem, Target.ysnUnlimitedQuantity = Source.ysnUnlimitedQuantity, Target.ysnMaxPrice = Source.ysnMaxPrice, Target.intINCOLocationTypeId = Source.intINCOLocationTypeId, Target.intCountryId = Source.intCountryId, Target.intCompanyLocationPricingLevelId = Source.intCompanyLocationPricingLevelId, Target.ysnProvisional = Source.ysnProvisional, Target.ysnLoad = Source.ysnLoad, Target.intNoOfLoad = Source.intNoOfLoad, Target.dblQuantityPerLoad = Source.dblQuantityPerLoad, Target.intLoadUOMId = Source.intLoadUOMId, Target.ysnCategory = Source.ysnCategory, Target.ysnMultiplePriceFixation = Source.ysnMultiplePriceFixation, Target.intCategoryUnitMeasureId = Source.intCategoryUnitMeasureId, Target.intLoadCategoryUnitMeasureId = Source.intLoadCategoryUnitMeasureId, Target.intArbitrationId = Source.intArbitrationId, Target.intProducerId = Source.intProducerId, Target.ysnExported = Source.ysnExported, Target.dtmExported = Source.dtmExported, Target.intCreatedById = Source.intCreatedById, Target.dtmCreated = Source.dtmCreated, Target.intLastModifiedById = Source.intLastModifiedById, Target.dtmLastModified = Source.dtmLastModified
             WHEN NOT MATCHED BY TARGET THEN
             INSERT (intContractHeaderId, intConcurrencyId, intContractTypeId, intEntityId, intEntityContactId, intContractPlanId, intCommodityId, dblQuantity, intCommodityUOMId, strContractNumber, dtmContractDate, strCustomerContract, dtmDeferPayDate, dblDeferPayRate, intContractTextId, ysnSigned, dtmSigned, ysnPrinted, intSalespersonId, intGradeId, intWeightId, intCropYearId, strInternalComment, strPrintableRemarks, intAssociationId, intTermId, intPricingTypeId, intApprovalBasisId, intContractBasisId, intPositionId, intInsuranceById, intInvoiceTypeId, dblTolerancePct, dblProvisionalInvoicePct, ysnSubstituteItem, ysnUnlimitedQuantity, ysnMaxPrice, intINCOLocationTypeId, intCountryId, intCompanyLocationPricingLevelId, ysnProvisional, ysnLoad, intNoOfLoad, dblQuantityPerLoad, intLoadUOMId, ysnCategory, ysnMultiplePriceFixation, intCategoryUnitMeasureId, intLoadCategoryUnitMeasureId, intArbitrationId, intProducerId, ysnExported, dtmExported, intCreatedById, dtmCreated, intLastModifiedById, dtmLastModified)
             VALUES (Source.intContractHeaderId, Source.intConcurrencyId, Source.intContractTypeId, Source.intEntityId, Source.intEntityContactId, Source.intContractPlanId, Source.intCommodityId, Source.dblQuantity, Source.intCommodityUOMId, Source.strContractNumber, Source.dtmContractDate, Source.strCustomerContract, Source.dtmDeferPayDate, Source.dblDeferPayRate, Source.intContractTextId, Source.ysnSigned, Source.dtmSigned, Source.ysnPrinted, Source.intSalespersonId, Source.intGradeId, Source.intWeightId, Source.intCropYearId, Source.strInternalComment, Source.strPrintableRemarks, Source.intAssociationId, Source.intTermId, Source.intPricingTypeId, Source.intApprovalBasisId, Source.intContractBasisId, Source.intPositionId, Source.intInsuranceById, Source.intInvoiceTypeId, Source.dblTolerancePct, Source.dblProvisionalInvoicePct, Source.ysnSubstituteItem, Source.ysnUnlimitedQuantity, Source.ysnMaxPrice, Source.intINCOLocationTypeId, Source.intCountryId, Source.intCompanyLocationPricingLevelId, Source.ysnProvisional, Source.ysnLoad, Source.intNoOfLoad, Source.dblQuantityPerLoad, Source.intLoadUOMId, Source.ysnCategory, Source.ysnMultiplePriceFixation, Source.intCategoryUnitMeasureId, Source.intLoadCategoryUnitMeasureId, Source.intArbitrationId, Source.intProducerId, Source.ysnExported, Source.dtmExported, Source.intCreatedById, Source.dtmCreated, Source.intLastModifiedById, Source.dtmLastModified)
             WHEN NOT MATCHED BY SOURCE THEN
             DELETE;';

    SET @SQLString = 'Exec('' '  + Replace(@SQLString, 'repDB', @remoteDB) + ' '')'

    SET IDENTITY_INSERT tblCTContractHeader ON
    EXECUTE sp_executesql @SQLString;
    SET IDENTITY_INSERT tblCTContractHeader OFF

    -- tblCTContractDetail
    SET @SQLString = N'MERGE tblCTContractDetail AS Target
        USING (SELECT * FROM REMOTEDBSERVER.[repDB].[dbo].[tblCTContractDetail]) AS Source
        ON (Target.intContractDetailId = Source.intContractDetailId)
        WHEN MATCHED THEN
            UPDATE SET Target.intConcurrencyId = Source.intConcurrencyId, Target.intContractHeaderId = Source.intContractHeaderId, Target.intContractStatusId = Source.intContractStatusId, Target.intContractSeq = Source.intContractSeq, Target.intCompanyLocationId = Source.intCompanyLocationId, Target.dtmStartDate = Source.dtmStartDate, Target.dtmEndDate = Source.dtmEndDate, Target.intFreightTermId = Source.intFreightTermId, Target.intShipViaId = Source.intShipViaId, Target.intItemContractId = Source.intItemContractId, Target.intItemId = Source.intItemId, Target.intCategoryId = Source.intCategoryId, Target.dblQuantity = Source.dblQuantity, Target.intItemUOMId = Source.intItemUOMId, Target.dblOriginalQty = Source.dblOriginalQty, Target.dblBalance = Source.dblBalance, Target.dblIntransitQty = Source.dblIntransitQty, Target.dblScheduleQty = Source.dblScheduleQty, Target.dblNetWeight = Source.dblNetWeight, Target.intNetWeightUOMId = Source.intNetWeightUOMId, Target.intUnitMeasureId = Source.intUnitMeasureId, Target.intCategoryUOMId = Source.intCategoryUOMId, Target.intNoOfLoad = Source.intNoOfLoad, Target.dblQuantityPerLoad = Source.dblQuantityPerLoad, Target.intIndexId = Source.intIndexId, Target.dblAdjustment = Source.dblAdjustment, Target.intAdjItemUOMId = Source.intAdjItemUOMId, Target.intPricingTypeId = Source.intPricingTypeId, Target.intFutureMarketId = Source.intFutureMarketId, Target.intFutureMonthId = Source.intFutureMonthId, Target.dblFutures = Source.dblFutures, Target.dblBasis = Source.dblBasis, Target.dblOriginalBasis = Source.dblOriginalBasis, Target.dblCashPrice = Source.dblCashPrice, Target.dblTotalCost = Source.dblTotalCost, Target.intCurrencyId = Source.intCurrencyId, Target.intPriceItemUOMId = Source.intPriceItemUOMId, Target.dblNoOfLots = Source.dblNoOfLots, Target.intMarketZoneId = Source.intMarketZoneId, Target.intDiscountTypeId = Source.intDiscountTypeId, Target.intDiscountId = Source.intDiscountId, Target.intDiscountScheduleId = Source.intDiscountScheduleId, Target.intDiscountScheduleCodeId = Source.intDiscountScheduleCodeId, Target.intStorageScheduleRuleId = Source.intStorageScheduleRuleId, Target.intContractOptHeaderId = Source.intContractOptHeaderId, Target.strBuyerSeller = Source.strBuyerSeller, Target.intBillTo = Source.intBillTo, Target.intFreightRateId = Source.intFreightRateId, Target.strFobBasis = Source.strFobBasis, Target.intRailGradeId = Source.intRailGradeId, Target.strRailRemark = Source.strRailRemark, Target.strLoadingPointType = Source.strLoadingPointType, Target.intLoadingPortId = Source.intLoadingPortId, Target.strDestinationPointType = Source.strDestinationPointType, Target.intDestinationPortId = Source.intDestinationPortId, Target.strShippingTerm = Source.strShippingTerm, Target.intShippingLineId = Source.intShippingLineId, Target.strVessel = Source.strVessel, Target.intDestinationCityId = Source.intDestinationCityId, Target.intShipperId = Source.intShipperId, Target.strRemark = Source.strRemark, Target.intFarmFieldId = Source.intFarmFieldId, Target.strGrade = Source.strGrade, Target.strVendorLotID = Source.strVendorLotID, Target.strInvoiceNo = Source.strInvoiceNo, Target.strReference = Source.strReference, Target.intUnitsPerLayer = Source.intUnitsPerLayer, Target.intLayersPerPallet = Source.intLayersPerPallet, Target.dtmEventStartDate = Source.dtmEventStartDate, Target.dtmPlannedAvailabilityDate = Source.dtmPlannedAvailabilityDate, Target.dtmUpdatedAvailabilityDate = Source.dtmUpdatedAvailabilityDate, Target.intBookId = Source.intBookId, Target.intSubBookId = Source.intSubBookId, Target.intContainerTypeId = Source.intContainerTypeId, Target.intNumberOfContainers = Source.intNumberOfContainers, Target.intInvoiceCurrencyId = Source.intInvoiceCurrencyId, Target.dtmFXValidFrom = Source.dtmFXValidFrom, Target.dtmFXValidTo = Source.dtmFXValidTo, Target.dblRate = Source.dblRate, Target.intFXPriceUOMId = Source.intFXPriceUOMId, Target.strFXRemarks = Source.strFXRemarks, Target.dblAssumedFX = Source.dblAssumedFX, Target.strFixationBy = Source.strFixationBy, Target.strPackingDescription = Source.strPackingDescription, Target.intCurrencyExchangeRateId = Source.intCurrencyExchangeRateId, Target.intCreatedById = Source.intCreatedById, Target.dtmCreated = Source.dtmCreated, Target.intLastModifiedById = Source.intLastModifiedById, Target.dtmLastModified = Source.dtmLastModified
        WHEN NOT MATCHED BY TARGET THEN
            INSERT (intContractDetailId, intConcurrencyId, intContractHeaderId, intContractStatusId, intContractSeq, intCompanyLocationId, dtmStartDate, dtmEndDate, intFreightTermId, intShipViaId, intItemContractId, intItemId, intCategoryId, dblQuantity, intItemUOMId, dblOriginalQty, dblBalance, dblIntransitQty, dblScheduleQty, dblNetWeight, intNetWeightUOMId, intUnitMeasureId, intCategoryUOMId, intNoOfLoad, dblQuantityPerLoad, intIndexId, dblAdjustment, intAdjItemUOMId, intPricingTypeId, intFutureMarketId, intFutureMonthId, dblFutures, dblBasis, dblOriginalBasis, dblCashPrice, dblTotalCost, intCurrencyId, intPriceItemUOMId, dblNoOfLots, intMarketZoneId, intDiscountTypeId, intDiscountId, intDiscountScheduleId, intDiscountScheduleCodeId, intStorageScheduleRuleId, intContractOptHeaderId, strBuyerSeller, intBillTo, intFreightRateId, strFobBasis, intRailGradeId, strRailRemark, strLoadingPointType, intLoadingPortId, strDestinationPointType, intDestinationPortId, strShippingTerm, intShippingLineId, strVessel, intDestinationCityId, intShipperId, strRemark, intFarmFieldId, strGrade, strVendorLotID, strInvoiceNo, strReference, intUnitsPerLayer, intLayersPerPallet, dtmEventStartDate, dtmPlannedAvailabilityDate, dtmUpdatedAvailabilityDate, intBookId, intSubBookId, intContainerTypeId, intNumberOfContainers, intInvoiceCurrencyId, dtmFXValidFrom, dtmFXValidTo, dblRate, intFXPriceUOMId, strFXRemarks, dblAssumedFX, strFixationBy, strPackingDescription, intCurrencyExchangeRateId, intCreatedById, dtmCreated, intLastModifiedById, dtmLastModified)
            VALUES (Source.intContractDetailId, Source.intConcurrencyId, Source.intContractHeaderId, Source.intContractStatusId, Source.intContractSeq, Source.intCompanyLocationId, Source.dtmStartDate, Source.dtmEndDate, Source.intFreightTermId, Source.intShipViaId, Source.intItemContractId, Source.intItemId, Source.intCategoryId, Source.dblQuantity, Source.intItemUOMId, Source.dblOriginalQty, Source.dblBalance, Source.dblIntransitQty, Source.dblScheduleQty, Source.dblNetWeight, Source.intNetWeightUOMId, Source.intUnitMeasureId, Source.intCategoryUOMId, Source.intNoOfLoad, Source.dblQuantityPerLoad, Source.intIndexId, Source.dblAdjustment, Source.intAdjItemUOMId, Source.intPricingTypeId, Source.intFutureMarketId, Source.intFutureMonthId, Source.dblFutures, Source.dblBasis, Source.dblOriginalBasis, Source.dblCashPrice, Source.dblTotalCost, Source.intCurrencyId, Source.intPriceItemUOMId, Source.dblNoOfLots, Source.intMarketZoneId, Source.intDiscountTypeId, Source.intDiscountId, Source.intDiscountScheduleId, Source.intDiscountScheduleCodeId, Source.intStorageScheduleRuleId, Source.intContractOptHeaderId, Source.strBuyerSeller, Source.intBillTo, Source.intFreightRateId, Source.strFobBasis, Source.intRailGradeId, Source.strRailRemark, Source.strLoadingPointType, Source.intLoadingPortId, Source.strDestinationPointType, Source.intDestinationPortId, Source.strShippingTerm, Source.intShippingLineId, Source.strVessel, Source.intDestinationCityId, Source.intShipperId, Source.strRemark, Source.intFarmFieldId, Source.strGrade, Source.strVendorLotID, Source.strInvoiceNo, Source.strReference, Source.intUnitsPerLayer, Source.intLayersPerPallet, Source.dtmEventStartDate, Source.dtmPlannedAvailabilityDate, Source.dtmUpdatedAvailabilityDate, Source.intBookId, Source.intSubBookId, Source.intContainerTypeId, Source.intNumberOfContainers, Source.intInvoiceCurrencyId, Source.dtmFXValidFrom, Source.dtmFXValidTo, Source.dblRate, Source.intFXPriceUOMId, Source.strFXRemarks, Source.dblAssumedFX, Source.strFixationBy, Source.strPackingDescription, Source.intCurrencyExchangeRateId, Source.intCreatedById, Source.dtmCreated, Source.intLastModifiedById, Source.dtmLastModified)
        WHEN NOT MATCHED BY SOURCE THEN
            DELETE;';

    SET @SQLString = 'Exec('' ' + Replace(@SQLString, 'repDB', @remoteDB) + ' '')'
    SET IDENTITY_INSERT tblCTContractDetail ON
    EXECUTE sp_executesql @SQLString;

    SET IDENTITY_INSERT tblCTContractDetail OFF

    -- tblCTContractCost
    SET @SQLString = N'MERGE tblCTContractCost AS Target
        USING (SELECT * FROM REMOTEDBSERVER.[repDB].[dbo].[tblCTContractCost]) AS Source
        ON (Target.intContractCostId = Source.intContractCostId)
        WHEN MATCHED THEN
            UPDATE SET Target.intConcurrencyId = Source.intConcurrencyId, Target.intContractDetailId = Source.intContractDetailId, Target.intItemId = Source.intItemId, Target.intVendorId = Source.intVendorId, Target.strCostMethod = Source.strCostMethod, Target.intCurrencyId = Source.intCurrencyId, Target.dblRate = Source.dblRate, Target.intItemUOMId = Source.intItemUOMId, Target.dblFX = Source.dblFX, Target.ysnAccrue = Source.ysnAccrue, Target.ysnMTM = Source.ysnMTM, Target.ysnPrice = Source.ysnPrice
        WHEN NOT MATCHED BY TARGET THEN
            INSERT (intContractCostId, intConcurrencyId, intContractDetailId, intItemId, intVendorId, strCostMethod, intCurrencyId, dblRate, intItemUOMId, dblFX, ysnAccrue, ysnMTM, ysnPrice)
            VALUES (Source.intContractCostId, Source.intConcurrencyId, Source.intContractDetailId, Source.intItemId, Source.intVendorId, Source.strCostMethod, Source.intCurrencyId, Source.dblRate, Source.intItemUOMId, Source.dblFX, Source.ysnAccrue, Source.ysnMTM, Source.ysnPrice)
        WHEN NOT MATCHED BY SOURCE THEN
            DELETE;';

    SET @SQLString = 'Exec('' ' + Replace(@SQLString, 'repDB', @remoteDB) + ' '')'
    SET IDENTITY_INSERT tblCTContractCost ON
    EXECUTE sp_executesql @SQLString;
    SET IDENTITY_INSERT tblCTContractCost OFF

END