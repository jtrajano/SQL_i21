CREATE PROCEDURE uspSCTicketContractUsedBasisContractValidation
	@TICKET_ID INT,
	@SCREEN NVARCHAR(20)

AS
BEGIN

-- contract validation
	BEGIN
		DECLARE @CURRENT_TICKET_CONTRACT_USED_ID INT
		DECLARE @CONTRACT_NUMBER_AFFECTED NVARCHAR(500) = ''
		DECLARE @CONTRACT_AFFECTED_LOOP_HOLDER NVARCHAR(500)
		
		DECLARE @LOOP_CONTRACT_DETAIL_ID INT
		DECLARE @LOOP_QUANTITY NUMERIC (38, 20)	
		DECLARE @BASIS_CONTRACT_CHECKING table (
			id INT IDENTITY(1,1)
			, intContractDetailId INT
			, dblScheduleQty NUMERIC (38, 20)	
		)

		INSERT INTO @BASIS_CONTRACT_CHECKING(intContractDetailId, dblScheduleQty)
		SELECT 
			A.intContractDetailId
			,A.dblScheduleQty
		FROM tblSCTicketContractUsed A
		INNER JOIN tblCTContractDetail B
			ON A.intContractDetailId = B.intContractDetailId
		INNER JOIN tblCTContractHeader C
			ON B.intContractHeaderId = C.intContractHeaderId
		WHERE A.intTicketId = @TICKET_ID
			AND (C.intPricingTypeId = 2 OR C.intPricingTypeId = 3)

			
		SELECT @CURRENT_TICKET_CONTRACT_USED_ID = MIN(id)
		FROM @BASIS_CONTRACT_CHECKING
			
				
		-- SELECT * FROM @BASIS_CONTRACT_CHECKING		
		WHILE @CURRENT_TICKET_CONTRACT_USED_ID IS NOT NULL
		BEGIN
			
			SELECT 
				@LOOP_CONTRACT_DETAIL_ID = intContractDetailId
				,@LOOP_QUANTITY = dblScheduleQty
				,@CONTRACT_AFFECTED_LOOP_HOLDER = ''
			FROM @BASIS_CONTRACT_CHECKING
			WHERE id = @CURRENT_TICKET_CONTRACT_USED_ID

			EXEC uspSCBasisContractValidation 
				@CONTRACT_DETAIL = @LOOP_CONTRACT_DETAIL_ID
				, @QUANTITY_TO_CHECK = @LOOP_QUANTITY
				, @SCREEN = @SCREEN
				, @SIMPLE_MESSAGE = 1
				, @NO_RAISE = 1
				, @OUTPUT = @CONTRACT_AFFECTED_LOOP_HOLDER OUTPUT
				
			SELECT @CONTRACT_AFFECTED_LOOP_HOLDER AS [CONTRACT AFFECTED LOOP], @LOOP_CONTRACT_DETAIL_ID, @LOOP_QUANTITY

			SET @CONTRACT_NUMBER_AFFECTED = @CONTRACT_NUMBER_AFFECTED + LTRIM(RTRIM(@CONTRACT_AFFECTED_LOOP_HOLDER))

			SELECT @CURRENT_TICKET_CONTRACT_USED_ID = min(id)
			FROM @BASIS_CONTRACT_CHECKING
			WHERE id > @CURRENT_TICKET_CONTRACT_USED_ID 

		END
		
		DELETE FROM @BASIS_CONTRACT_CHECKING
		
		IF(@CONTRACT_NUMBER_AFFECTED <> '')
		BEGIN

			DECLARE @ERROR_MESSAGE NVARCHAR(200) = 'Cannot distribute to contract with not enough Priced Quantity (' + @CONTRACT_NUMBER_AFFECTED + ') .'
			RAISERROR(@ERROR_MESSAGE, 11, 1);	

		END

				

	END

END