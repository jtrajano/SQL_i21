CREATE VIEW [dbo].[vyuCTContractDetail]
	AS
	with header as (
		select
			ch.intContractHeaderId
			,ch.ysnQuantityAtHeaderLevel
			,dblHeaderBalance = ch.dblQuantity - sum(cd.dblQuantity - cd.dblBalance)
			,dblHeaderAvailable = ch.dblQuantity - (sum(cd.dblQuantity - cd.dblBalance) + sum(isnull(cd.dblScheduleQty,0)))
			,ch.intContractTypeId
		from
			tblCTContractDetail cd
			join tblCTContractHeader ch on ch.intContractHeaderId = cd.intContractHeaderId
		group by
			ch.intContractHeaderId
			,ch.ysnQuantityAtHeaderLevel
			,ch.dblQuantity
			,ch.intContractTypeId
	)
	select
		intContractDetailId = cd.intContractDetailId
		,intSplitFromId = cd.intSplitFromId
		,intParentDetailId = cd.intParentDetailId
		,ysnSlice = cd.ysnSlice
		,intConcurrencyId = cd.intConcurrencyId
		,intContractHeaderId = cd.intContractHeaderId
		,intContractStatusId = cd.intContractStatusId
		,strFinancialStatus = cd.strFinancialStatus
		,intContractSeq = cd.intContractSeq
		,intCompanyLocationId = cd.intCompanyLocationId
		,intShipToId = cd.intShipToId
		,dtmStartDate = cd.dtmStartDate
		,dtmEndDate = cd.dtmEndDate
		,intFreightTermId = cd.intFreightTermId
		,intShipViaId = cd.intShipViaId
		,intItemContractId = cd.intItemContractId
		,intItemBundleId = cd.intItemBundleId
		,intItemId = cd.intItemId
		,strItemSpecification = cd.strItemSpecification
		,intCategoryId = cd.intCategoryId
		,dblQuantity = cd.dblQuantity
		,intItemUOMId = cd.intItemUOMId
		,dblOriginalQty = cd.dblOriginalQty
		,dblBalance = case when isnull(h.ysnQuantityAtHeaderLevel,0) = 0 then cd.dblBalance else h.dblHeaderBalance end
		,dblIntransitQty = cd.dblIntransitQty
		,dblScheduleQty = case when isnull(h.ysnQuantityAtHeaderLevel,0) = 0 then cd.dblScheduleQty else h.dblHeaderBalance - h.dblHeaderAvailable end
		,dblBalanceLoad = cd.dblBalanceLoad
		,dblScheduleLoad = cd.dblScheduleLoad
		,dblShippingInstructionQty = cd.dblShippingInstructionQty
		,dblNetWeight = cd.dblNetWeight
		,intNetWeightUOMId = cd.intNetWeightUOMId
		,intUnitMeasureId = cd.intUnitMeasureId
		,intCategoryUOMId = cd.intCategoryUOMId
		,intNoOfLoad = cd.intNoOfLoad
		,dblQuantityPerLoad = cd.dblQuantityPerLoad
		,intIndexId = cd.intIndexId
		,dblAdjustment = cd.dblAdjustment
		,intAdjItemUOMId = cd.intAdjItemUOMId
		,intPricingTypeId = cd.intPricingTypeId
		,intFutureMarketId = cd.intFutureMarketId
		,intFutureMonthId = cd.intFutureMonthId
		,dblFutures = cd.dblFutures
		,dblBasis = cd.dblBasis
		,dblOriginalBasis = cd.dblOriginalBasis
		,dblConvertedBasis = cd.dblConvertedBasis
		,intBasisCurrencyId = cd.intBasisCurrencyId
		,intBasisUOMId = cd.intBasisUOMId
		,dblFreightBasisBase = cd.dblFreightBasisBase
		,intFreightBasisBaseUOMId = cd.intFreightBasisBaseUOMId
		,dblFreightBasis = cd.dblFreightBasis
		,intFreightBasisUOMId = cd.intFreightBasisUOMId
		,dblRatio = cd.dblRatio
		,dblCashPrice = cd.dblCashPrice
		,dblTotalCost = cd.dblTotalCost
		,intCurrencyId = cd.intCurrencyId
		,intPriceItemUOMId = cd.intPriceItemUOMId
		,dblNoOfLots = cd.dblNoOfLots
		,dtmLCDate = cd.dtmLCDate
		,dtmLastPricingDate = cd.dtmLastPricingDate
		,dblConvertedPrice = cd.dblConvertedPrice
		,intConvPriceCurrencyId = cd.intConvPriceCurrencyId
		,intConvPriceUOMId = cd.intConvPriceUOMId
		,intMarketZoneId = cd.intMarketZoneId
		,intDiscountTypeId = cd.intDiscountTypeId
		,intDiscountId = cd.intDiscountId
		,intDiscountScheduleId = cd.intDiscountScheduleId
		,intDiscountScheduleCodeId = cd.intDiscountScheduleCodeId
		,intStorageScheduleRuleId = cd.intStorageScheduleRuleId
		,intContractOptHeaderId = cd.intContractOptHeaderId
		,strBuyerSeller = cd.strBuyerSeller
		,intBillTo = cd.intBillTo
		,intFreightRateId = cd.intFreightRateId
		,strFobBasis = cd.strFobBasis
		,intRailGradeId = cd.intRailGradeId
		,strRailRemark = cd.strRailRemark
		,strLoadingPointType = cd.strLoadingPointType
		,intLoadingPortId = cd.intLoadingPortId
		,strDestinationPointType = cd.strDestinationPointType
		,intDestinationPortId = cd.intDestinationPortId
		,intCostTermId = cd.intCostTermId
		,strShippingTerm = cd.strShippingTerm
		,intShippingLineId = cd.intShippingLineId
		,strVessel = cd.strVessel
		,intDestinationCityId = cd.intDestinationCityId
		,intShipperId = cd.intShipperId
		,strRemark = cd.strRemark
		,intSubLocationId = cd.intSubLocationId
		,intStorageLocationId = cd.intStorageLocationId
		,intPurchasingGroupId = cd.intPurchasingGroupId
		,intFarmFieldId = cd.intFarmFieldId
		,intSplitId = cd.intSplitId
		,strGrade = cd.strGrade
		,strGarden = cd.strGarden
		,strVendorLotID = cd.strVendorLotID
		,strInvoiceNo = cd.strInvoiceNo
		,strReference = cd.strReference
		,strERPPONumber = cd.strERPPONumber
		,strERPItemNumber = cd.strERPItemNumber
		,strERPBatchNumber = cd.strERPBatchNumber
		,intUnitsPerLayer = cd.intUnitsPerLayer
		,intLayersPerPallet = cd.intLayersPerPallet
		,dtmEventStartDate = cd.dtmEventStartDate
		,dtmPlannedAvailabilityDate = cd.dtmPlannedAvailabilityDate
		,dtmUpdatedAvailabilityDate = cd.dtmUpdatedAvailabilityDate
		,dtmM2MDate = cd.dtmM2MDate
		,intBookId = cd.intBookId
		,intSubBookId = cd.intSubBookId
		,intContainerTypeId = cd.intContainerTypeId
		,intNumberOfContainers = cd.intNumberOfContainers
		,intInvoiceCurrencyId = cd.intInvoiceCurrencyId
		,dtmFXValidFrom = cd.dtmFXValidFrom
		,dtmFXValidTo = cd.dtmFXValidTo
		,dblRate = cd.dblRate
		,dblFXPrice = cd.dblFXPrice
		,ysnUseFXPrice = cd.ysnUseFXPrice
		,intFXPriceUOMId = cd.intFXPriceUOMId
		,strFXRemarks = cd.strFXRemarks
		,dblAssumedFX = cd.dblAssumedFX
		,strFixationBy = cd.strFixationBy
		,strPackingDescription = cd.strPackingDescription
		,dblYield = cd.dblYield
		,intCurrencyExchangeRateId = cd.intCurrencyExchangeRateId
		,intRateTypeId = cd.intRateTypeId
		,intCreatedById = cd.intCreatedById
		,dtmCreated = cd.dtmCreated
		,intLastModifiedById = cd.intLastModifiedById
		,dtmLastModified = cd.dtmLastModified
		,ysnInvoice = cd.ysnInvoice
		,ysnProvisionalInvoice = cd.ysnProvisionalInvoice
		,ysnQuantityFinal = cd.ysnQuantityFinal
		,intProducerId = cd.intProducerId
		,ysnClaimsToProducer = cd.ysnClaimsToProducer
		,ysnRiskToProducer = cd.ysnRiskToProducer
		,ysnBackToBack = cd.ysnBackToBack
		,dblAllocatedQty = cd.dblAllocatedQty
		,dblReservedQty = cd.dblReservedQty
		,dblAllocationAdjQty = cd.dblAllocationAdjQty
		,dblInvoicedQty = cd.dblInvoicedQty
		,ysnPriceChanged = cd.ysnPriceChanged
		,intContractDetailRefId = cd.intContractDetailRefId
		,ysnStockSale = cd.ysnStockSale
		,strCertifications = cd.strCertifications
		,ysnSplit = cd.ysnSplit
		,ysnProvisionalPNL = cd.ysnProvisionalPNL
		,ysnFinalPNL = cd.ysnFinalPNL
		,dtmProvisionalPNL = cd.dtmProvisionalPNL
		,dtmFinalPNL = cd.dtmFinalPNL
		,intPricingStatus = cd.intPricingStatus
		,dtmStartDateUTC = cd.dtmStartDateUTC
		,dblRefFuturesQty = cd.dblRefFuturesQty
		,intRefFuturesItemUOMId = cd.intRefFuturesItemUOMId
		,intRefFuturesCurrencyId = cd.intRefFuturesCurrencyId
		,intRefFuturesMarketId = cd.intRefFuturesMarketId
		,intRefFuturesMonthId = cd.intRefFuturesMonthId
		,ysnAutoShortClosed = cd.ysnAutoShortClosed
		,ysnCashFlowOverride = cd.ysnCashFlowOverride
		,dtmCashFlowDate = cd.dtmCashFlowDate
		,strFinanceTradeNo = cd.strFinanceTradeNo
		,intBankAccountId = cd.intBankAccountId
		,intBankId = cd.intBankId
		,intBorrowingFacilityId = cd.intBorrowingFacilityId
		,intBorrowingFacilityLimitId = cd.intBorrowingFacilityLimitId
		,intBorrowingFacilityLimitDetailId = cd.intBorrowingFacilityLimitDetailId
		,strReferenceNo = cd.strReferenceNo
		,dblLoanAmount = cd.dblLoanAmount
		,intBankValuationRuleId = cd.intBankValuationRuleId
		,strBankReferenceNo = cd.strBankReferenceNo
		,strComments = cd.strComments
		,intFacilityId = cd.intFacilityId
		,intLoanLimitId = cd.intLoanLimitId
		,intOverrideFacilityId = cd.intOverrideFacilityId
		,ysnSubmittedToBank = cd.ysnSubmittedToBank
		,dtmDateSubmitted = cd.dtmDateSubmitted
		,intApprovalStatusId = cd.intApprovalStatusId
		,dtmDateApproved = cd.dtmDateApproved
		,dblInterestRate = cd.dblInterestRate
		,dtmPrepaymentDate = cd.dtmPrepaymentDate
		,dblPrepaymentAmount = cd.dblPrepaymentAmount
		,dtmHistoricalDate = cd.dtmHistoricalDate
		,dblHistoricalRate = cd.dblHistoricalRate
		,intHistoricalRateTypeId = cd.intHistoricalRateTypeId
		,dblQualityPremium = cd.dblQualityPremium
		,dblOptionalityPremium = cd.dblOptionalityPremium
		,dblBudgetPrice = cd.dblBudgetPrice
		,dblTotalBudget = cd.dblTotalBudget
		,intLocalCurrencyId = cd.intLocalCurrencyId
		,intLocalUOMId = cd.intLocalUOMId
		,dblLocalCashPrice = cd.dblLocalCashPrice
		,intAverageUOMId = cd.intAverageUOMId
		,dblAverageQuantity = cd.dblAverageQuantity
		,strLCNumber = cd.strLCNumber
		,intLCApplicantId = cd.intLCApplicantId
		,strLCType = cd.strLCType
		,strLCStatus = cd.strLCStatus
		,strLCConfirmation = cd.strLCConfirmation
		,dtmLCDate2 = cd.dtmLCDate2
		,dtmLCValidityDate = cd.dtmLCValidityDate
		,dtmLCLatestDateOfReceipt = cd.dtmLCLatestDateOfReceipt
		,intLCPlaceOfIssuingId = cd.intLCPlaceOfIssuingId
		,intLCPaymentTermId = cd.intLCPaymentTermId
		,strLCReference = cd.strLCReference
		,strLCFeesBreakdown = cd.strLCFeesBreakdown
		,dtmLCStartPeriod = cd.dtmLCStartPeriod
		,dtmLCEndPeriod = cd.dtmLCEndPeriod
		,strLCPresentation = cd.strLCPresentation
		,intLCTreasuryBankId = cd.intLCTreasuryBankId
		,intLCBankId = cd.intLCBankId
		,strLCBankRole = cd.strLCBankRole
		,ysnTransportPartialShipment = cd.ysnTransportPartialShipment
		,ysnTransportTransShipment = cd.ysnTransportTransShipment
		,ysnTransportMultiplePorts = cd.ysnTransportMultiplePorts
		,dblQuantityMinRate = cd.dblQuantityMinRate
		,dblAmountMinRate = cd.dblAmountMinRate
		,dblQuantityMaxRate = cd.dblQuantityMaxRate
		,dblAmountMaxRate = cd.dblAmountMaxRate
		,dblQuantityMinValue = cd.dblQuantityMinValue
		,dblAmountMinValue = cd.dblAmountMinValue
		,dblQuantityMaxValue = cd.dblQuantityMaxValue
		,dblAmountMaxValue = cd.dblAmountMaxValue
		,intVendorLocationId = cd.intVendorLocationId
		,ysnApplyDefaultTradeFinance = cd.ysnApplyDefaultTradeFinance
		,ysnTaxOverride = cd.ysnTaxOverride
		,strTaxPoint = cd.strTaxPoint
		,intTaxGroupId = cd.intTaxGroupId
		,strTaxLocation = cd.strTaxLocation
		,intTaxLocationId = cd.intTaxLocationId
		,ysnRoll = cd.ysnRoll
		,strContractReference = cd.strContractReference
		,intItemXrefId = cd.intItemXrefId
		,strItemXrefProduct = case when h.intContractTypeId = 1 then vx.strVendorProduct else cx.strCustomerProduct end
	from
		tblCTContractDetail cd
		left join header h on h.intContractHeaderId = cd.intContractHeaderId
		left join tblICItemVendorXref vx on vx.intItemVendorXrefId = cd.intItemXrefId
		left join tblICItemCustomerXref cx on cx.intItemCustomerXrefId = cd.intItemXrefId
