CREATE VIEW dbo.vyuMFBatch   
AS  
SELECT
    A.intBatchId,
    A.strBatchId,
    A.intSales,
    A.intSalesYear,
    A.dtmSalesDate,
    A.strTeaType,
    A.intBrokerId,
    A.strVendorLotNumber,
    A.intBuyingCenterLocationId,
    A.intParentBatchId,
    A.intInventoryReceiptId,
    A.intSampleId,
    A.intContractDetailId,
    A.str3PLStatus,
    A.strSupplierReference,
    A.strAirwayBillCode,
    A.strAWBSampleReceived,
    A.strAWBSampleReference,
    A.dblBasePrice,
    A.ysnBoughtAsReserved,
    A.ysnBoughtPrice,
    A.intBrokerWarehouseId,
    A.dblBulkDensity,
    A.strBuyingOrderNumber,
    A.intSubBookId,
    A.strContainerNumber,
    A.intCurrencyId,
    A.dtmProductionBatch,
    A.dtmTeaAvailableFrom,
    A.strDustContent,
    A.ysnEUCompliant,
    A.strTBOEvaluatorCode,
    A.strEvaluatorRemarks,
    A.dtmExpiration,
    A.intFromPortId,
    A.dblGrossWeight,
    A.dtmInitialBuy,
    A.dblWeightPerUnit,
    A.dblLandedPrice,
    A.strLeafCategory,
    A.strLeafManufacturingType,
    A.strLeafSize,
    A.strLeafStyle,
    A.intMixingUnitLocationId,
    A.dblPackagesBought,
    A.intItemUOMId,
	A.intWeightUOMId,
    A.strTeaOrigin,
    A.intOriginalItemId,
    A.dblPackagesPerPallet,
    A.strPlant,
    A.dblTotalQuantity,
    A.strSampleBoxNumber,
    A.dblSellingPrice,
    A.dtmStock,
    A.strSubChannel,
    A.ysnStrategic,
    A.strTeaLingoSubCluster,
    A.dtmSupplierPreInvoiceDate,
    A.strSustainability,
    A.strTasterComments,
    A.dblTeaAppearance,
    A.strTeaBuyingOffice,
    A.strTeaColour,
    A.strTeaGardenChopInvoiceNumber,
    A.intGardenMarkId,
    A.strTeaGroup,
    A.dblTeaHue,
    A.dblTeaIntensity,
    A.strLeafGrade,
    A.dblTeaMoisture,
    A.dblTeaMouthFeel,
    A.ysnTeaOrganic,
    A.dblTeaTaste,
    A.dblTeaVolume,
    A.intTealingoItemId,
    A.dtmWarehouseArrival,
    A.intYearManufacture,
    A.strPackageSize,
    A.intPackageUOMId,
    A.dblTareWeight,
    A.strTaster,
    A.strFeedStock,
    A.strFlourideLimit,
    A.strLocalAuctionNumber,
    A.strPOStatus,
    A.strProductionSite,
    A.strReserveMU,
    A.strQualityComments,
    A.strRareEarth,
    strParentBatchId = B.strBatchId,
    C.strTINNumber,
    C.intTINClearanceId,
    strStorageLocation = D.strSubLocationName,
    strStorageUnit = E.strName,
    A.intStorageLocationId,
    A.intStorageUnitId,
    A.strFreightAgent,
	A.strSealNumber,
	A.strContainerType,
	A.strVoyage,
	A.strVessel 
    A.intConcurrencyId
FROM tblMFBatch A
LEFT JOIN tblMFBatch B ON A.intParentBatchId = B.intBatchId
OUTER APPLY(SELECT TOP 1 intTINClearanceId, strTINNumber FROM  tblQMTINClearance  WHERE intBatchId = A.intBatchId )C
OUTER APPLY( 
    SELECT TOP 1 strSubLocationName FROM tblSMCompanyLocationSubLocation 
    WHERE A.intStorageLocationId = intCompanyLocationSubLocationId
)D
OUTER APPLY( SELECT TOP 1 strName FROM tblICStorageLocation ICS
WHERE A.intStorageUnitId = ICS.intStorageLocationId)E
